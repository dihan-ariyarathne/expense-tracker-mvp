{% extends "base.html" %}

{% block title %}Dashboard - Expense Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </h1>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Current Balance</h5>
                <h2 class="card-text {% if current_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                    Rs. {{ "%.2f"|format(current_balance) }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">Today's Income</h5>
                <h2 class="card-text text-success">Rs. {{ "%.2f"|format(today_income) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger">Today's Expenses</h5>
                <h2 class="card-text text-danger">Rs. {{ "%.2f"|format(today_expense) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">Last Transaction</h5>
                {% if last_transaction %}
                <p class="card-text">
                    <strong>{{ last_transaction.t_type.title() }}</strong><br>
                    <small class="text-muted">{{ last_transaction.category }} - Rs. {{ "%.2f"|format(last_transaction.amount) }}</small>
                </p>
                {% else %}
                <p class="card-text text-muted">No transactions yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Pie Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Expense Categories
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="pieRange" id="pieDay" value="day" checked>
                    <label class="btn btn-outline-primary" for="pieDay">Day</label>
                    
                    <input type="radio" class="btn-check" name="pieRange" id="pieWeek" value="week">
                    <label class="btn btn-outline-primary" for="pieWeek">Week</label>
                    
                    <input type="radio" class="btn-check" name="pieRange" id="pieMonth" value="month">
                    <label class="btn btn-outline-primary" for="pieMonth">Month</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Line Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Daily Expense Trends
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="linePeriod" id="lineWeek" value="week" checked>
                    <label class="btn btn-outline-primary" for="lineWeek">Week</label>
                    
                    <input type="radio" class="btn-check" name="linePeriod" id="lineMonth" value="month">
                    <label class="btn btn-outline-primary" for="lineMonth">Month</label>
                    
                    <input type="radio" class="btn-check" name="linePeriod" id="lineYear" value="year">
                    <label class="btn btn-outline-primary" for="lineYear">Year</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Quick Actions</h5>
                <a href="{{ url_for('new_transaction') }}" class="btn btn-primary me-2">
                    <i class="fas fa-plus me-1"></i>Add Transaction
                </a>
                <a href="{{ url_for('new_transaction') }}?type=income" class="btn btn-success me-2">
                    <i class="fas fa-arrow-up me-1"></i>Add Income
                </a>
                <a href="{{ url_for('new_transaction') }}?type=expense" class="btn btn-danger">
                    <i class="fas fa-arrow-down me-1"></i>Add Expense
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pieChart, lineChart;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    loadPieChart('day');
    loadLineChart('week');
    
    // Add event listeners for toggles
    document.querySelectorAll('input[name="pieRange"]').forEach(radio => {
        radio.addEventListener('change', function() {
            loadPieChart(this.value);
        });
    });
    
    document.querySelectorAll('input[name="linePeriod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            loadLineChart(this.value);
        });
    });
});

function loadPieChart(range) {
    fetch(`/api/pie?range=${range}`)
        .then(response => response.json())
        .then(data => {
            if (pieChart) {
                pieChart.destroy();
            }
            
            const ctx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#FF6384',
                            '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading pie chart:', error);
        });
}

function loadLineChart(period) {
    fetch(`/api/trends?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (lineChart) {
                lineChart.destroy();
            }
            
            const ctx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Daily Expenses',
                        data: data.data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading line chart:', error);
        });
}
</script>
{% endblock %}
